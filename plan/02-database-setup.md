# Step 02 — Database Setup, Migrations & Tenant Provisioning

## Goal
Set up Drizzle ORM with the existing PostgreSQL schema, create migration infrastructure, build tenant provisioning scripts, and add seed data for development.

## Prerequisites
- Step 01 completed (monorepo structure exists)
- PostgreSQL 18 running locally
- `schema.sql` available in repo root

---

## Prompt

You are building the database layer for a UK insurance broker policy admin SaaS. The PostgreSQL schema already exists in `schema.sql` at the repo root. You need to set up Drizzle ORM in the `packages/api` package.

### Architecture context (from CLAUDE.md):
- **Multi-tenancy**: Schema-per-tenant. Each broker gets `broker_<uuid>` schema. A shared `meta` schema holds cross-tenant tables (broker registry, system config).
- **Connection-level search_path** sets tenant context.
- Defense-in-depth: application-level tenant checks + schema isolation + RLS.

### Files to create:

```
packages/api/
├── drizzle.config.ts              # Drizzle Kit config
├── src/
│   ├── db/
│   │   ├── connection.ts          # PostgreSQL connection pool setup
│   │   ├── tenant.ts             # Tenant connection helper (sets search_path)
│   │   ├── schema/
│   │   │   ├── index.ts          # Re-exports all tables
│   │   │   ├── brokers.ts        # brokers table (meta schema)
│   │   │   ├── users.ts          # users table
│   │   │   ├── customers.ts      # customers table
│   │   │   ├── policies.ts       # policies table
│   │   │   ├── policy-versions.ts # policy_versions table
│   │   │   ├── policy-financials.ts # policy_financials table
│   │   │   ├── policy-risk-items.ts # policy_risk_items table
│   │   │   ├── binders.ts        # binders table
│   │   │   ├── products.ts       # products table
│   │   │   ├── claims.ts         # claims table
│   │   │   ├── complaints.ts     # complaints table
│   │   │   ├── invoices.ts       # invoices table
│   │   │   ├── receipts.ts       # receipts & receipt_allocations tables
│   │   │   ├── commission.ts     # commission_splits & commission_clawbacks tables
│   │   │   ├── documents.ts      # documents table
│   │   │   ├── emails.ts         # emails & email_templates tables
│   │   │   ├── audit-log.ts      # audit_log table
│   │   │   ├── bordereaux.ts     # bordereaux_runs & bordereaux_items tables
│   │   │   ├── renewals.ts       # renewals table
│   │   │   ├── roles.ts          # roles, permissions, role_permissions tables
│   │   │   ├── tax-rates.ts      # tax_rates table
│   │   │   ├── kyc.ts            # kyc_checks table
│   │   │   ├── ipid.ts           # ipid_templates & ipid_acknowledgements tables
│   │   │   └── customer-timeline.ts # customer_timeline table
│   │   │
│   │   ├── migrations/           # Generated by drizzle-kit
│   │   └── seed/
│   │       ├── seed.ts           # Main seed runner
│   │       ├── meta-seed.ts      # Seed meta schema (demo broker, system roles)
│   │       └── tenant-seed.ts    # Seed tenant data (demo customers, policies, products)
│   │
│   └── services/
│       └── tenant-provisioning.ts # Create/drop tenant schema
```

### Requirements:

1. **Drizzle schema files**: Translate every table from `schema.sql` into Drizzle table definitions. Match column types exactly:
   - `uuid DEFAULT gen_random_uuid()` → `uuid('id').defaultRandom().primaryKey()`
   - `text NOT NULL` → `text('column_name').notNull()`
   - `numeric(12,2)` → `numeric('column_name', { precision: 12, scale: 2 })`
   - `numeric(5,2)` → `numeric('column_name', { precision: 5, scale: 2 })`
   - `timestamp with time zone DEFAULT now()` → `timestamp('created_at', { withTimezone: true }).defaultNow()`
   - `boolean DEFAULT false` → `boolean('column_name').default(false)`
   - `jsonb` → `jsonb('column_name')`
   - `inet` → `text('ip_address')` (Drizzle doesn't have inet, store as text)
   - `date` → `date('column_name')`
   - Include all CHECK constraints as comments (Drizzle doesn't support CHECK natively, enforce in application)
   - Define all foreign key relations using `relations()` from drizzle-orm

2. **Connection pool** (`connection.ts`):
   - Use `postgres` (pg) driver with Drizzle
   - Connection string from `DATABASE_URL` env var
   - Pool size configurable via `DB_POOL_SIZE` env (default 20)
   - Export a function `getDb()` that returns the Drizzle instance

3. **Tenant connection helper** (`tenant.ts`):
   - Export `getTenantDb(brokerId: string)` that:
     - Gets a connection from pool
     - Sets `search_path` to `broker_<brokerId>,public`
     - Returns a Drizzle instance scoped to that tenant
   - Export `withTenant<T>(brokerId: string, fn: (db: DrizzleInstance) => Promise<T>): Promise<T>` wrapper
   - Always reset search_path after use (use try/finally)

4. **Tenant provisioning** (`tenant-provisioning.ts`):
   - `createTenantSchema(brokerId: string)`: Creates `broker_<brokerId>` schema, runs all table creation DDL within it, sets up RLS policies
   - `dropTenantSchema(brokerId: string)`: Drops the schema (with safety check — only in dev/test)
   - Log all provisioning actions

5. **Seed data** (`seed/`):
   - **Meta seed**: Create a demo broker ("Acme Insurance Brokers", FCA number "123456"), create system-level roles (Broker Admin, Broker User, Compliance Officer, Claims Handler, Readonly Auditor) with appropriate permissions
   - **Tenant seed**: For the demo broker, create:
     - 2 offices
     - 3 users (admin, standard user, compliance officer)
     - 2 binders with 3 products (1 retail motor, 1 retail home, 1 commercial property)
     - 5 customers (3 retail, 2 commercial)
     - 3 policies in various states (1 in_force, 1 quoted, 1 cancelled) with versions and financials
     - IPT tax rates for current UK rates (12% standard, 20% travel)
     - Sample email templates (quote confirmation, policy issued, renewal notice)
   - Seed should be idempotent (check before insert)

6. **Drizzle config** (`drizzle.config.ts`):
   - Schema path pointing to `src/db/schema/`
   - Output migrations to `src/db/migrations/`
   - Use `postgres` driver
   - Connection from `DATABASE_URL`

7. **Package.json scripts** (add to api package):
   - `db:generate` — run drizzle-kit generate
   - `db:migrate` — run drizzle-kit migrate
   - `db:seed` — run seed script with tsx
   - `db:provision` — provision a new tenant schema (accepts broker ID arg)

### Acceptance criteria:
- `pnpm --filter api db:generate` generates migration files
- `pnpm --filter api db:migrate` applies migrations to a local PostgreSQL
- `pnpm --filter api db:seed` populates demo data
- Drizzle schema matches `schema.sql` exactly (all tables, columns, constraints, indexes)
- `getTenantDb()` correctly scopes queries to tenant schema
- TypeScript types inferred by Drizzle match the shared types from Step 01
